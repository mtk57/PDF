ログ設計 memo



・ログ設計指針が重要視され過ぎで、セキュリティ対策の一環や迅速なトラブル対応のために、
　ありとあらゆるログを取得するといったプロジェクトをまれに目にする。
・しかしそうなると、逆にログが膨大な量になり、解析に時間がかかるうえ、
　運用が開始されると結局、重要なログメッセージのみを監視するということになりがちである。
・ログ自体を出力しなければ、ログ出力がパフォーマンストラブルを引き起こすこともないだろう。

・本当に必要なログが決まったら、出力するログの目的に応じたログレベルやログ出力方式を決定する。

LEVEL  使用例
-------------------------------------------------------------------------------------------
trace  ループ内部の変数などdebugの中でも大量に出力されるメッセージ。
       あまり使用しているプロジェクトはない

debug  セッション内部の情報やユーザーHTTPリクエスト、レスポンス情報など、
       開発中やテスト用のデバッグメッセージ

info   アプリケーションの起動情報やログインしたユーザーIDなど毎回出力させたいメッセージ

warn   2重ログイン禁止のシステムで2重ログイン要求が発生したなど
       想定内の問題が発生したが、リクエストを処理し運用に問題ないメッセージ

error  DBサーバが無応答など、ユーザーからの処理を処理できない場合

fatal  アプリケーションがこれ以上動作できない場合など。
       あまり使用しているプロジェクトはない


-------------------------------------------------------------------------------------------
■ログポリシー

#  ポリシー
-------------
1  本ポリシーの適用は、以下の3サービスとする。
   md, cd, rd

2  保持する過去ログのサイズ制限が厳しいため、正常動作時は最低限の情報だけを出力するに留める方針とする。

3  各サービス毎にログローテート（※１）を行い、保持する過去ログは一定数以上増加しないようにする。

4  設計値としての過去ログの最大保持数については、過去ログを保持するディスク領域のサイズが不明のため、
   割当予定サイズから逆算して求めるものとする。

5  ログ増加頻度が高い運用では過去ログの最大保持数が重要であり、逆の場合は過去ログの最大保持期間が重要となる。
   サービスの性質上、前者の値がより重要とする。

6  デフォルトのログレベル設定は以下とする。
   正常動作時はイベントログ、ログともに何も出力しない。
   ・イベントログ：WARNING
   ・ログ：WARNING
   ・トレース：INFO

7  ログレベル毎の出力内容
   ・WARNING以上：一般的なポリシーと同じ。解析に役立つよう可能な限り詳細な情報を出力すること。
   ・INFO：※２
   ・DEBUG：INFOの詳細版。変数の内容、呼び出しメソッド名、引数、戻り地など。
   ・TRACE：ライブラリの情報など。

8  ログ回収時に全ての過去ログを回収しようとするのは無駄なため、過去ログはログ回収の対象外となる領域に配置する。

9  過去ログは以下のオプションにより選別できるようにする。
   ・回収対象（サービス、ボリューム、ブリック）
   ・回収世代
10 過去ログ最大保持数、最大保持期間、過去ログ格納ディレクトリパス等は設定ファイルに定義し、サービス起動時に変更できるように設計する。


※１  ログローテートの動作イメージ
      1.カレントログサイズが閾値を超えた場合、リネーム・圧縮を行う。この圧縮ファイルを過去ログと呼ぶ。
      2.過去ログの最大保持数、もしくは最大保持期間の閾値を超えた場合、最古の過去ログから閾値までの過去ログを全て削除する。
        つまり、保持する過去ログ数はある時点からは増えない。
※２  INFOで出力する内容
      1.サービスの開始・停止などの動作上の契機
      2.起動時の共通情報（読み込んだDB、設定ファイルの値）
      3.転送対象のパス、対象の属性情報などのサービス固有の重要情報。（1KB以内）



■過去ログの最大保持数の求める
  ※太字は計算式が入っているので編集禁止


 ●固定パラメータ
   <共通>
   ディスクサイズ    2,000  [MB/Dir]                           J32
   圧縮率            30.0   [%]                                J33

   ディスク割当率      30.0 [%]     30.0 [%]     30.0 [%]      J36
   カレントログサイズ  10.0 [MB]    10.0 [MB]    10.0 [MB]     J37

 ●動的パラメータ
   ディスク割当サイズ   600 [MB]     600 [MB]     600 [MB]     J41   =J32*J36/100
   過去ログサイズ       3.0 [MB]     3.0 [MB]     3.0 [MB]     J42   =J37*J33/100



●総ディスク割当率        90.0 [%]                                   =J36+P36+V36
●総ディスク割当サイズ 1,800.0 [MB]                                  =J41+P41+V41
●総過去ログ保持数         590 [個]                                  =J51+P51+V51

●過去ログ最大保持数       197 [個]   197 [個]   197 [個]            =ABS((J37-J41)/J42)














